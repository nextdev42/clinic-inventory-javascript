<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <title>Sajili Matumizi ya Dawa</title>
  <style>
    .description {
      margin: 10px 0;
      font-style: italic;
      color: #444;
    }
    .error {
      color: red;
    }
    .dawa-item {
      margin-bottom: 10px;
    }
    input.quantity-input:invalid {
      border: 2px solid red;
    }
  </style>
</head>
<body>
  <h1>Sajili Matumizi ya Dawa</h1>

  <% if (error) { %>
    <p class="error"><%= error %></p>
  <% } %>

  <form action="/matumizi/sajili" method="POST" onsubmit="return validateForm()">
    <label for="mtumiaji">Chagua Mtumiaji:</label>
    <select name="mtumiaji" id="mtumiaji" onchange="onUserChange()" required>
      <option value="">-- Chagua --</option>
      <% watumiaji.forEach(w => { %>
        <option value="<%= w.jina %>" data-desc="<%= w.maelezo %>"
          <%= selectedUser === w.jina ? 'selected' : '' %>>
          <%= w.jina %>
        </option>
      <% }); %>
    </select>

    <div id="desc" class="description">
      <% if (selectedUserDesc) { %>
        <%= selectedUserDesc %>
      <% } %>
    </div>

    <hr>

    <h3>Dawa</h3>
    <% dawa.forEach((d, i) => { %>
      <div class="dawa-item">
        <label>
          <input type="checkbox" name="dawa[]" value="<%= d.jina %>" class="checkbox">
          <%= d.jina %>
        </label>
        <input 
          type="number" 
          name="kiasi[]" 
          class="quantity-input" 
          placeholder="Weka kiasi" 
          min="1"
        >
      </div>
    <% }) %>

    <button type="submit">Sajili</button>
  </form>

<script>
  function validateForm() {
    const items = document.querySelectorAll('.dawa-item');
    let atLeastOneChecked = false;
    let formValid = true;

    items.forEach(item => {
      const checkbox = item.querySelector('.checkbox');
      const input = item.querySelector('.quantity-input');

      input.style.border = '';

      if (checkbox.checked) {
        atLeastOneChecked = true;
        const value = input.value.trim();
        const amount = parseInt(value, 10);

        if (!value || isNaN(amount) || amount <= 0) {
          input.style.border = '2px solid red';
          formValid = false;
        }
      }
    });

    if (!atLeastOneChecked) {
      alert("Tafadhali chagua angalau dawa moja.");
      return false;
    }

    if (!formValid) {
      alert("Tafadhali weka kiasi halali kwa dawa ulizochagua.");
      return false;
    }

    return true;
  }

  window.onload = onUserChange;
</script>

</body>
</html>
