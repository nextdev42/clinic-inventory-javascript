<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <title>Sajili Matumizi ya Dawa</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .dawa-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .dawa-row input[type="number"] { width: 60px; }
    .success-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
    .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
  </style>
</head>
<body>
  <main class="container">
    <h1>Sajili Matumizi ya Dawa</h1>

    <div id="success" class="success-message"></div>
    <div id="errorMsg" class="error"></div>

    <form id="matumiziForm" action="/matumizi/sajili" method="POST">
      <div class="form-group">
        <label for="clinic">Kituo cha Afya:</label>
        <input type="text" id="clinic" name="clinic" value="<%= clinic %>" readonly />
      </div>

      <div class="form-group">
        <label for="userSelect">Chagua Mtumiaji:</label>
        <select id="userSelect" name="userId" required>
          <option value="">-- Tafadhali Chagua --</option>
          <% watumiaji.forEach(user => { %>
            <option value="<%= user.id %>" data-description="<%= user.maelezo || '' %>">
              <%= user.jina %>
            </option>
          <% }); %>
        </select>
        <p id="descriptionText" style="margin-top:5px; font-style:italic;">Chagua mtumiaji kuona maelezo</p>
      </div>

      <h2>Dawa Zilizopo</h2>
      <% dawa.forEach((d, index) => { %>
        <div class="dawa-row">
          <label>
            <input type="checkbox" class="confirm-checkbox" name="dawaList[<%= index %>][confirm]" value="yes" />
            <%= d.jina %>
          </label>
          <input type="hidden" name="dawaList[<%= index %>][id]" value="<%= d.id %>" />
          <input type="number" name="dawaList[<%= index %>][kiasi]" placeholder="Kiasi" min="1" />
          <input type="hidden" name="dawaList[<%= index %>][tarehe]" />
        </div>
      <% }); %>

      <div class="button-group">
        <button type="submit">Hifadhi Matumizi</button>
        <a href="/matumizi">Rudi Nyumbani</a>
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const userSelect = document.getElementById('userSelect');
      const descText = document.getElementById('descriptionText');
      const form = document.getElementById('matumiziForm');
      const errorDiv = document.getElementById('errorMsg');
      const successDiv = document.getElementById('success');

      userSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');

        if (this.value && description && description.trim() !== '') {
          descText.textContent = description;
        } else if (this.value) {
          descText.textContent = 'Hakuna maelezo ya matumizi kwa mtumiaji huyu';
        } else {
          descText.textContent = 'Chagua mtumiaji kuona maelezo';
        }
      });

      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const confirmed = document.querySelectorAll('.confirm-checkbox:checked').length > 0;
        if (!confirmed) {
          errorDiv.textContent = 'Tafadhali thibitisha angalau dawa moja iliyotolewa';
          errorDiv.style.display = 'block';
          successDiv.style.display = 'none';
          return false;
        }

        let valid = true;
        document.querySelectorAll('.confirm-checkbox:checked').forEach(checkbox => {
          const row = checkbox.closest('.dawa-row');
          const quantityInput = row.querySelector('input[type="number"]');

          if (!quantityInput.value || parseInt(quantityInput.value) < 1) {
            quantityInput.style.border = '2px solid red';
            valid = false;
          } else {
            quantityInput.style.border = '';
          }

          const index = checkbox.name.match(/\[(\d+)\]/)[1];
          document.querySelector(`input[name="dawaList[${index}][tarehe]"]`).value = new Date().toISOString();
        });

        if (!valid) {
          errorDiv.textContent = 'Tafadhali weka kiasi sahihi kwa dawa zilizothibitishwa';
          errorDiv.style.display = 'block';
          return false;
        }

        this.submit();
      });

      if (new URLSearchParams(window.location.search).has('success')) {
        successDiv.textContent = 'âœ… Matumizi ya dawa yamehifadhiwa kikamilifu!';
        successDiv.style.display = 'block';
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 3000);
      }

      userSelect.dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html>
