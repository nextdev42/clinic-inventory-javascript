<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <title>Sajili Matumizi ya Dawa</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    form {
      background: white;
      padding: 25px;
      max-width: 700px;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
      color: #34495e;
    }
    select, input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .dawa-item {
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      background: #f9f9f9;
    }
    .dawa-item h4 {
      margin: 0 0 10px 0;
      color: #2980b9;
    }
    .dawa-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }
    .dawa-controls input[type="number"] {
      flex: 1;
      max-width: 100px;
    }
    .dawa-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      font-weight: normal;
    }
    .dawa-controls input[type="checkbox"] {
      transform: scale(1.2);
    }
    button {
      padding: 12px 20px;
      background: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px;
      transition: background 0.3s;
      margin-right: 10px;
    }
    button:hover {
      background: #2ecc71;
    }
    .button-group {
      margin-top: 25px;
      display: flex;
      justify-content: space-between;
    }
    .user-description {
      margin: 15px 0;
      padding: 12px;
      background: #e8f4fc;
      border-left: 4px solid #3498db;
      border-radius: 6px;
    }
    .user-description strong {
      display: block;
      margin-bottom: 5px;
    }
    .error-message {
      color: #e74c3c;
      padding: 10px;
      background: #fdecea;
      border-radius: 4px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }
    .success-message {
      color: #27ae60;
      padding: 10px;
      background: #e8f8f0;
      border-radius: 4px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }
    .has-description {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>üìù Sajili Matumizi ya Dawa</h2>

  <form action="/matumizi/sajili" method="POST" id="matumiziForm">
    <div class="form-section">
      <label for="mtumiajiId">Chagua Mtumiaji:</label>
      <select name="mtumiajiId" id="mtumiajiId" required>
        <option value="">-- Chagua mtumiaji --</option>
        <% watumiaji.forEach(u => { %>
          <option value="<%= u.id %>" 
                  data-description="<%= u.maelezo || '' %>"
                  <%= u.maelezo ? 'class="has-description"' : '' %>>
            <%= u.jina %>
            <% if (u.maelezo && u.maelezo.trim() !== '') { %>
              (ina maelezo)
            <% } %>
          </option>
        <% }) %>
      </select>

      <div class="user-description" id="userDescription">
        <strong>Maelezo ya Matumizi:</strong>
        <div id="descriptionText">Hakuna mtumiaji aliyechaguliwa</div>
      </div>
    </div>

    <div class="form-section">
      <h3>Dawa Zilizotolewa</h3>
      
      <% dawa.forEach((d, index) => { %>
        <div class="dawa-item">
          <h4><%= d.jina %> (<%= d.aina %>)</h4>
          
          <input type="hidden" name="dawaList[<%= index %>][id]" value="<%= d.id %>" />
          
          <div class="dawa-controls">
            <div>
              <label>Kiasi:</label>
              <input type="number" name="dawaList[<%= index %>][kiasi]" min="1" 
                     placeholder="1" required style="width: 80px;">
            </div>
            
            <label>
              <input type="checkbox" class="confirm-checkbox" 
                     name="dawaList[<%= index %>][confirmed]" value="true">
              Dawa imetolewa
            </label>
          </div>
          
          <input type="hidden" name="dawaList[<%= index %>][tarehe]" class="auto-tarehe">
        </div>
      <% }) %>
    </div>

    <div class="error-message" id="errorMsg"></div>
    <div class="success-message" id="successMsg"></div>

    <div class="button-group">
      <button type="submit">üíæ Hifadhi Matumizi</button>
      <button type="button" onclick="window.location.href='/'">‚Ü© Rudi Nyuma</button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize user description display
      const userSelect = document.getElementById('mtumiajiId');
      const descText = document.getElementById('descriptionText');
      
      userSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        
        if (this.value && description && description.trim() !== '') {
          descText.textContent = description;
        } else if (this.value) {
          descText.textContent = 'Hakuna maelezo ya matumizi kwa mtumiaji huyu';
        } else {
          descText.textContent = 'Hakuna mtumiaji aliyechaguliwa';
        }
      });
      
      // Initialize form validation
      const form = document.getElementById('matumiziForm');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const confirmed = document.querySelectorAll('.confirm-checkbox:checked').length > 0;
        const errorDiv = document.getElementById('errorMsg');
        const successDiv = document.getElementById('successMsg');
        
        if (!confirmed) {
          errorDiv.textContent = 'Tafadhali thibitisha angalau dawa moja iliyotolewa';
          errorDiv.style.display = 'block';
          successDiv.style.display = 'none';
          return false;
        }
        
        // Set current date for confirmed medicines
        const now = new Date().toISOString();
        document.querySelectorAll('.confirm-checkbox:checked').forEach(checkbox => {
          const index = checkbox.name.match(/\[(\d+)\]/)[1];
          document.querySelector(`input[name="dawaList[${index}][tarehe]"]`).value = now;
        });
        
        // Submit the form
        this.submit();
      });
      
      // Show success message if redirected with success parameter
      if (new URLSearchParams(window.location.search).has('success')) {
        document.getElementById('successMsg').textContent = '‚úÖ Matumizi ya dawa yamehifadhiwa kikamilifu!';
        document.getElementById('successMsg').style.display = 'block';
        setTimeout(() => {
          document.getElementById('successMsg').style.display = 'none';
        }, 3000);
      }
      
      // Trigger initial description update
      userSelect.dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html>
