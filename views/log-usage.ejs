<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <title>Sajili Matumizi ya Dawa</title>
  <style>
    .description {
      margin: 10px 0;
      font-style: italic;
      color: #444;
    }
    .error {
      color: red;
    }
    .dawa-item {
      margin-bottom: 10px;
    }
    input.quantity-input:invalid {
      border: 2px solid red;
    }
  </style>
</head>
<body>
  <h1>Sajili Matumizi ya Dawa</h1>

  <% if (error) { %>
    <p class="error"><%= error %></p>
  <% } %>

  <form action="/matumizi/sajili" method="POST" onsubmit="return validateForm()">
    <label for="mtumiaji">Chagua Mtumiaji:</label>
    <select name="mtumiaji" id="mtumiaji" onchange="onUserChange()" required>
      <option value="">-- Chagua --</option>
      <% watumiaji.forEach(w => { %>
        <option value="<%= w.jina %>" data-desc="<%= w.maelezo %>" 
          <%= w.jina === selectedUser ? 'selected' : '' %>>
          <%= w.jina %>
        </option>
      <% }); %>
    </select>

    <div id="desc" class="description">
      <% if (selectedUserDesc) { %>
        <%= selectedUserDesc %>
      <% } %>
    </div>

    <hr>

    <h3>Dawa</h3>
    <% dawa.forEach((d, i) => { %>
      <div class="dawa-item">
        <label>
          <input type="checkbox" name="dawa[]" value="<%= d.jina %>" class="checkbox">
          <%= d.jina %>
        </label>
        <input 
          type="number" 
          name="kiasi[]" 
          class="quantity-input" 
          placeholder="Kiasi (kwa mfano: 1, 2)" 
          min="1"
        >
      </div>
    <% }) %>

    <button type="submit">Sajili</button>
  </form>

  <script>
    function onUserChange() {
      const selected = document.getElementById('mtumiaji').selectedOptions[0];
      const desc = selected.getAttribute('data-desc') || '';
      document.getElementById('desc').innerText = desc;
    }

    function validateForm() {
      const items = document.querySelectorAll('.dawa-item');
      let atLeastOneChecked = false;
      let valid = true;

      items.forEach(item => {
        const checkbox = item.querySelector('.checkbox');
        const input = item.querySelector('.quantity-input');

        if (checkbox.checked) {
          atLeastOneChecked = true;
          const quantity = parseInt(input.value, 10);
          if (isNaN(quantity) || quantity < 1) {
            input.style.border = '2px solid red';
            valid = false;
          } else {
            input.style.border = '';
          }
        } else {
          input.style.border = '';
        }
      });

      if (!atLeastOneChecked) {
        alert("Tafadhali chagua angalau dawa moja.");
        return false;
      }

      if (!valid) {
        alert("Weka kiasi halali cha dawa kwa dawa zilizochaguliwa.");
        return false;
      }

      return true;
    }

    // Run on page load
    window.onload = onUserChange;
  </script>
</body>
</html>
