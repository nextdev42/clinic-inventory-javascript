<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <title>Sajili Matumizi ya Dawa</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    label, select, input[type="number"] {
      display: block;
      margin-top: 10px;
      width: 100%;
    }
    .dawa-row {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      background: #fafafa;
    }
    .dawa-row input[type="checkbox"] {
      transform: scale(1.3);
      margin-right: 10px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      padding: 12px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-primary {
      background: #28a745;
    }
    .btn-secondary {
      background: #6c757d;
    }
    .success-message {
      display: none;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
      background-color: #d4edda;
      color: #155724;
      border-radius: 6px;
    }
    .error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      padding: 10px;
      background-color: #f8d7da;
      border-radius: 4px;
    }
    #userDescription {
      margin: 15px 0;
      padding: 12px;
      background: #e8f4fc;
      border-left: 4px solid #3498db;
      border-radius: 6px;
    }
    .description-text {
      font-style: italic;
      margin-top: 5px;
    }
    .back-button {
      margin-bottom: 20px;
    }
    .back-button a {
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .back-button a:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Back Button at the top -->
    <div class="back-button">
      <a href="/">
        <span style="margin-right: 5px;">‚Üê</span> Rudi Nyumbani
      </a>
    </div>

    <h2>üìù Sajili Matumizi ya Dawa</h2>

    <form action="/matumizi/sajili" method="POST" id="matumiziForm">
      <label for="userSelect">Chagua Mtumiaji:</label>
      <select id="userSelect" name="mtumiajiId" required>
        <option value="">-- Chagua mtumiaji --</option>
        <% watumiaji.forEach(user => { %>
  <option value="<%= user.id %>" 
          data-description="<%= user.maelezo || '' %>">
    <%= user.jina %><%= user.maelezo && user.maelezo.trim() !== '' ? ' (ina maelezo)' : '' %>
  </option>
<% }) %>

      </select>

      <div id="userDescription">
        <strong>Maelezo ya Matumizi:</strong>
        <div id="descriptionText" class="description-text">Chagua mtumiaji kuona maelezo</div>
      </div>

      <h3 style="margin-top: 20px;">Chagua Dawa na Kiasi:</h3>
      <% dawa.forEach((d, index) => { %>
        <fieldset class="dawa-row">
          <legend><%= d.jina %> - <%= d.aina %></legend>

          <input type="hidden" name="dawaList[<%= index %>][id]" value="<%= d.id %>" />

          <label>Kiasi:</label>
          <input type="number" name="dawaList[<%= index %>][kiasi]" min="1" placeholder="e.g. 1" required />

          <label style="display: flex; align-items: center; margin-top: 10px;">
            <input type="checkbox" class="confirm-checkbox" name="dawaList[<%= index %>][confirmed]" value="true" />
            <span style="margin-left: 8px;">‚úÖ Dawa imetolewa</span>
          </label>

          <input type="hidden" name="dawaList[<%= index %>][tarehe]" class="auto-tarehe" />
        </fieldset>
      <% }) %>

      <div id="errorMsg" class="error"></div>

      <div class="button-group">
        <button type="submit" class="btn btn-primary">üíæ Hifadhi Matumizi</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">üè† Rudi Nyumbani</button>
      </div>
    </form>

    <div id="success" class="success-message">‚úÖ Matumizi ya dawa yamehifadhiwa vizuri!</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize user description display
      const userSelect = document.getElementById('userSelect');
      const descText = document.getElementById('descriptionText');
      
      userSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        
        if (this.value && description && description.trim() !== '') {
          descText.textContent = description;
        } else if (this.value) {
          descText.textContent = 'Hakuna maelezo ya matumizi kwa mtumiaji huyu';
        } else {
          descText.textContent = 'Chagua mtumiaji kuona maelezo';
        }
      });
      
      // Initialize form validation
      const form = document.getElementById('matumiziForm');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const confirmed = document.querySelectorAll('.confirm-checkbox:checked').length > 0;
        const errorDiv = document.getElementById('errorMsg');
        const successDiv = document.getElementById('successMsg');
        
        if (!confirmed) {
          errorDiv.textContent = 'Tafadhali thibitisha angalau dawa moja iliyotolewa';
          errorDiv.style.display = 'block';
          successDiv.style.display = 'none';
          return false;
        }
        
        // Set current date for confirmed medicines
        const now = new Date().toISOString();
        document.querySelectorAll('.confirm-checkbox:checked').forEach(checkbox => {
          const index = checkbox.name.match(/\[(\d+)\]/)[1];
          document.querySelector(`input[name="dawaList[${index}][tarehe]"]`).value = now;
        });
        
        // Submit the form
        this.submit();
      });
      
      // Show success message if redirected with success parameter
      if (new URLSearchParams(window.location.search).has('success')) {
        document.getElementById('success').textContent = '‚úÖ Matumizi ya dawa yamehifadhiwa kikamilifu!';
        document.getElementById('success').style.display = 'block';
        setTimeout(() => {
          document.getElementById('success').style.display = 'none';
        }, 3000);
      }
      
      // Trigger initial description update
      userSelect.dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html>
